#!/usr/bin/env zsh
set -e

cd "$(dirname "$0")/../.."

link_file() {
    source_path="$PWD/$1"
    target_path="$2"
    echo -e "\033[1;33mLinking $1 \033[0m"
    if ! [ -e "$source_path" ]; then
        echo error: path $source_path does not exist. >&2
        exit 1
    fi
    rm -rf "$target_path"
    ln -sf "$source_path" "$target_path"
}

zsh_command() {
    echo -e "\033[1;33mNow running $@ \033[0m..."
    zsh -c "$@"
}

mkdir -p ~/.config

link_file git/.gitignore ~/.gitignore
link_file nvim ~/.config/nvim
link_file ranger ~/.config/ranger
link_file psql/.psqlrc ~/.psqlrc
link_file tmux/.tmux.conf ~/.tmux.conf
link_file zsh/.zshenv ~/.zshenv
link_file zsh/.zshrc ~/.zshrc

. ~/.zshenv
. ~/.zshrc

osname=$(uname)
if [[ $osname == Darwin* ]]; then
    link_file pip ~/Library/Application\ Support/pip
    zsh_command '$DOTFILES/scripts/macos/brew-update'
    brew install \
        coreutils \
        curl \
        dash \
        diffutils \
        direnv \
        docker-completion \
        docker-compose-completion \
        fd \
        findutils \
        fzf \
        gawk \
        git \
        gnu-sed \
        gnu-tar \
        grep \
        htop \
        jq \
        kubectl \
        kubernetes-helm \
        mpd \
        ncmpcpp \
        neovim \
        openssh \
        p7zip \
        ripgrep \
        stern \
        tmux \
        tmux-xpanes \
        zsh
fi

if [[ $osname == Linux* ]]; then
    link_file pip ~/.config/pip

    if command -v pacman > /dev/null; then
        link_file pacman ~/.config/pacman
        yay -S --noconfirm \
            aria2 \
            aspell-en \
            bind-tools \
            dash \
            direnv \
            docker \
            fd \
            fuse2 \
            fzf \
            grub \
            htop \
            intel-ucode \
            jq \
            neovim \
            openssh \
            p7zip \
            pkgfile \
            python \
            reflector \
            ripgrep \
            rsync \
            sshfs \
            tmux \
            tmux-xpanes \
            yay
    fi

    if command -v termux-info > /dev/null; then
        rm -f ~/../usr/etc/motd

        yes | pkg update
        yes | pkg upgrade
        yes | pkg install \
            clang \
            coreutils \
            curl \
            direnv \
            dnsutils \
            fd \
            findutils \
            fzf \
            neovim \
            openssh \
            p7zip \
            python-dev \
            ranger \
            ripgrep \
            termux-api \
            tmux
        yes | apt autoremove
    fi
fi

mkdir -p ~/.local/bin
ln -sf "$(which dash)" "$HOME/.local/bin/sh"

zsh_command '$DOTFILES/scripts/python/pyenv-update'
if [[ $osname == Darwin* ]]; then
    zsh_command 'pyenv global 3.7.1'
fi
zsh_command '$DOTFILES/scripts/python/pip-update'
zsh_command 'PIP_REQUIRE_VIRTUALENV=0 pip install pipns'

for name in flake8 httpie speedtest-cli; do
    zsh_command "pipns -n "$name" install "$name""
done

# python on android doesn't support link and breaks ranger
# https://github.com/termux/termux-packages/blob/master/packages/ranger/ranger-core-actions.py.patch
if ! command -v termux-info > /dev/null; then
    zsh_command 'pipns -n ranger-fm install ranger-fm'
fi

if command -v docker > /dev/null; then
    zsh_command 'pipns -n ranger-fm install docker-compose'
fi

zsh_command nvim-update
