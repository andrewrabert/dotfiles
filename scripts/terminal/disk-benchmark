#!/usr/bin/env sh
set -e

show_usage() {
    cat << EOF
usage: disk-benchmark [-s SIZE] FILE
    -s, --size      size in megabytes. defaults to 1024M
        --help      show help and exit
EOF
}

FILESIZE=1024
while true; do
    case "$1" in
        -s)
            FILESIZE="$2"
            shift; shift
            ;;
        --help)
            show_usage
            exit
            ;;
        *)
            if [ $# -eq 0 ]; then
                show_usage >&2
                echo 'error: missing file' >&2
                exit 1
            fi
            break
    esac
done

TEMP_FILE="$1"
if [ -e "$TEMP_FILE" ]; then
    echo 'error: file already exists' >&2
    exit 1
fi

cleanup() {
    rm -f "${TEMP_FILE}"
}

trap cleanup EXIT

dd if=/dev/zero "of=$TEMP_FILE" bs=1M count="$FILESIZE" conv=fdatasync,notrunc status=progress
case "$(uname)" in
    Linux)
        sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'
        ;;
    Darwin)
        sync
        sudo purge
        ;;
    *)
        echo error: unhandled OS >&2
        exit 1
esac
dd "if=$TEMP_FILE" of=/dev/null bs=1M count="$FILESIZE" status=progress
