#!/usr/bin/env sh
set -eu

zstd_compress() {
    # -T0 uses number of cores, not threads
    zstd "-T$(nproc)" --ultra -22 "$@"
}

RM=1
if [ "$1" = '--keep' ]; then
    RM=
    shift
fi

if [ $# -ne 1 ]; then
    exit 1
fi

SOURCE="$(realpath "$1")"
DEST="$(basename "$SOURCE").tar.zst"

if [ -f "$SOURCE" ]; then
    tar cf - -C "$(dirname "$SOURCE")" "$(basename "$SOURCE")" | zstd_compress -o "$DEST"
elif [ -d "$SOURCE" ]; then
    find "$SOURCE" -printf '%P\0' | tar cf - -C "$SOURCE" --no-recursion --verbatim-files-from --null -T - | zstd_compress -o "$DEST"
else
    exit 1
fi
if [ -n "$RM" ]; then
    rm -rf "$SOURCE"
fi
