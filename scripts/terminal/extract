#!/usr/bin/env bash
set -e

gen_target() {
    target="${1%.*}"
    if [ -n "$EXTRACT_BASE" ]; then
        target="$EXTRACT_BASE/$(basename "$target")"
    fi
    if [ -n "$EXTRACT_IN_DIR" ]; then
        target="$(dirname "$target")"
    fi
    echo "$target"
}


while true; do
    if [ "$1" = '-i' ]; then
        EXTRACT_IN_DIR=1
        shift
    elif [ "$1" = '-r' ]; then
        EXTRACT_RM=1
        shift
    elif [ "$1" = '-d' ]; then
        EXTRACT_BASE="$2"
        shift
        shift
    else
        break
    fi
done

for filename in "$@"; do
    target="$(gen_target "$filename")"
    tarext=".tar."
    if [ "${filename#*$tarext}" != "$filename" ]; then
        target="$(gen_target "$target")"
        7z x "${filename}" -so | 7z x -aoa -si -ttar -o"${target}"
    else
        7z x -spe -o"${target}" "${filename}"
    fi
    if [ -n "$EXTRACT_RM" ]; then
        rm "$filename"
    fi
done
