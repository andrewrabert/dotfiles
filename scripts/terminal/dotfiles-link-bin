#!/usr/bin/env sh
TMP_BIN="$(mktemp -d)"

link_all() {
    for source_dir in "$@"; do
        if [ -d "$source_dir" ]; then
            for c in "$source_dir"/*; do
                if [ -f "$c" ]; then
                    n="${c##*/}"
                    if [ -h "$c" ]; then
                        cp "$(realpath "$c")" "${TMP_BIN}/${n}"
                    else
                        ln -sf "$c" "${TMP_BIN}/${n}"
                    fi
                fi
            done
        fi
    done
}

if ! [ -d "$DOTFILES" ]; then
    exit 1
fi
DEST_BIN="${DOTFILES}/.bin"

HOST="${HOST:-$(hostname)}"
link_all \
    "${DOTFILES}/scripts/hosts/${HOST}" \
    "${DOTFILES_PRIVATE}/scripts/hosts/${HOST}" \
    "${DOTFILES}"/scripts/commands/* \
    "${DOTFILES}/scripts/terminal" \
    "${DOTFILES_PRIVATE}/scripts/terminal" \

if [ -d ~/.local/share/nvm ]; then
    link_all \
        "${DOTFILES}/scripts/nvm"
fi

if [ -d ~/.local/share/base16-shell ]; then
    link_all \
        "${DOTFILES}/scripts/base16"
fi

case "$HOST" in
    mars)
        link_all \
            "${DOTFILES_PRIVATE}/scripts/gisual" \
           "${DOTFILES}/scripts/media"
        ;;
    phobos)
        link_all \
            "${DOTFILES_PRIVATE}/scripts/gisual" \
            "${DOTFILES}/scripts/media"
        ;;
    sol)
        link_all \
            "${DOTFILES}/scripts/media"
        ;;
esac

rm -rf "$DEST_BIN"
mv "$TMP_BIN" "$DEST_BIN"
