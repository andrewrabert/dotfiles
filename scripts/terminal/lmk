#!/usr/bin/env bash
set -e

TOPIC='lmk-fs-event'
LINK_PWD="$(readlink -f "$PWD")"

YELLOW='\033[1;33m'
RESET_COLOR='\033[0m'

kill_all() {
    jobs -rp | xargs -L 1 pkill -P &> /dev/null || true
    pkill -P $$ &> /dev/null || true
}

publish_message() {
    zepusu pub "$TOPIC" "$1"
}

get_message() {
    zepusu sub -t "$TOPIC" | cut -f2- -d ' '
}


if [ -z "$1" ]; then
    publish_message "$PWD"
    exit
elif [ "$1" = '--path' ]; then
    publish_message "$(readlink -f "$2")"
    exit
fi

while true; do
    if [ "$1" = '-a' ]; then
        LMK_ANY=1
        shift
    else
        break
    fi
done

trap "exit 1" INT
trap "kill_all" EXIT

exec_command() {
    set +e
    "$@"
    ret=$?
    printf '\n%blmk complete - %s - Exit %s%b' "$YELLOW" "$(date -u +"%Y-%m-%d %H:%M:%S")" $ret "$RESET_COLOR"
}

while true; do
    # exit tmux copy-mode
    if [ -n "$TMUX" ]; then
        tmux if -F -t "$TMUX_PANE" "#{pane_in_mode}" "send-keys -t $TMUX_PANE -X cancel"
    fi

    kill_all
    clear
    exec_command "$@" &

    disown
    while true; do
        EVENT_PATH=$(get_message)
        if [ -n "$LMK_ANY" ] || [[ "$EVENT_PATH"/ = "$PWD"/* ]] || [[ "$EVENT_PATH"/ = "$LINK_PWD"/* ]]; then
            break
        fi
    done
done
