#!/usr/bin/env sh
set -e

FANPIPE_TOPIC='lmk-fs-event'

publish_message() {
    fanpipe --publish --topic "$FANPIPE_TOPIC"
}

get_message() {
    fanpipe --subscribe --topic "$FANPIPE_TOPIC"
}

show_help() {
    cat << EOF
usage: lmk [--help] [COMMAND [ARGUMENT ...]]
    -q, --quiet     Suppress the exit status line
        --help      Display this help and exit
EOF
}

if [ -z "$1" ]; then
    publish_message "$PWD"
    exit
elif [ "$1" = '--path' ]; then
    publish_message "$(readlink -f "$2")"
    exit
fi


if [ -n "$LMK_INSIDE" ]; then
    tmux unbind -a
    tmux set-option destroy-unattached on
    tmux set-option detach-on-destroy on
    tmux set-option status off
    "$@" &
    get_message
    tmux new-window -k -t 0 lmk "$@"
else
    while true; do
        case "$1" in
            --help)
                show_help
                exit
                ;;
            *)
                break
        esac
    done

    unset TMUX
    LMK_INSIDE=1 tmux -L test -f /dev/null new-session -A lmk "$@"
fi
