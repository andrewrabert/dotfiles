#!/usr/bin/env sh
set -e

FANPIPE_TOPIC='lmk-fs-event'

publish_message() {
    fanpipe --publish --topic "$FANPIPE_TOPIC"
}

get_message() {
    fanpipe --subscribe --topic "$FANPIPE_TOPIC"
}

show_help() {
    cat << EOF
usage: lmk [--help] [COMMAND [ARGUMENT ...]]
    -q, --quiet     Suppress the exit status line
        --help      Display this help and exit
EOF
}

if [ -z "$1" ]; then
    publish_message "$PWD"
    exit
elif [ "$1" = '--path' ]; then
    publish_message "$(readlink -f "$2")"
    exit
fi


if [ -n "$LMK_INSIDE" ]; then
    "$@" &
    get_message
    tmux respawn-pane -k -t "$TMUX_PANE" lmk "$@"
else
    while true; do
        case "$1" in
            --help)
                show_help
                exit
                ;;
            *)
                break
        esac
    done

    if [ -z "$TMUX" ]; then
        LMK_INSIDE=1 tmux -L lmk-$$ -f /dev/null \
            new-session lmk "$@" ';' \
            set-option status off ';' \
            set-option destroy-unattached on ';' \
            set-option detach-on-destroy on ';' \
            attach
    else
        LMK_INSIDE=1 lmk "$@"
    fi
fi
