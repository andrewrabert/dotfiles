#!/usr/bin/env bash
set -e

TOPIC='lmk-fs-event'
LINK_PWD="$(readlink -f "$PWD")"

kill_all() {
    jobs -rp | xargs -L 1 pkill -P &> /dev/null || true
    pkill -P $$ &> /dev/null || true
}

publish_message() {
    zepusu pub "$TOPIC" "$1"
}

get_message() {
    zepusu sub -t "$TOPIC" | cut -f2- -d ' '
}


if [ "$1" = '-a' ]; then
    LMK_ANY=1
    shift
fi

if [ -z "$1" ]; then
    publish_message "$PWD"
    exit
elif [ "$1" = '--path' ]; then
    publish_message "$(readlink -f "$2")"
    exit
fi


trap "exit 1" SIGINT
trap "kill_all" EXIT

while true; do
    # exit tmux copy-mode
    if [ -n "$TMUX" ]; then
        tmux if -F -t "$TMUX_PANE" "#{pane_in_mode}" "send-keys -t $TMUX_PANE -X cancel"
    fi

    kill_all
    clear
    "$@" &

    disown
    while true; do
        EVENT_PATH=$(get_message)
        if [ -n "$LMK_ANY" ] || [[ "$EVENT_PATH"/ = "$PWD"/* ]] || [[ "$EVENT_PATH"/ = "$LINK_PWD"/* ]]; then
            break
        fi
    done
done
