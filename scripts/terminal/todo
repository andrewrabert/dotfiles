#!/usr/bin/env sh
set -e

NOTES_DIR="${NOTES_DIR:-$HOME/Notes}"
TODO_FILE="${NOTES_DIR}/todo.txt"

if [ "$(ls "${NOTES_DIR}" | grep '^todo.*.txt' | wc -l)" -gt 1 ] ; then
    echo error: sync conflict detected >&2
    exit 1
fi

show_help() {
    echo 'usage: todo TASK'
}

DUE=''
while true; do
    case "$1" in
        --due)
            DUE="$(date -I -d "$2")"
            shift
            shift
            ;;
        --help)
            show_help
            exit
            ;;
        *)
            if [ -n "$1" ]; then
                # xargs to strip multiple spaces
                echo "$(date -I)" "$@" "$DUE" | xargs >> "${TODO_FILE}"
            else
                exec "${EDITOR}" -c AutoSaveToggle "${TODO_FILE}"
            fi
            break
    esac
done
