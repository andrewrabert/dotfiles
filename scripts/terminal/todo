#!/usr/bin/env sh
set -e

NOTES_DIR="${NOTES_DIR:-$HOME/Notes}"
TODO_FILE="${NOTES_DIR}/todo.txt"

if [ "$(ls "${NOTES_DIR}" | grep '^todo.*.txt' | wc -l)" -gt 1 ] ; then
    echo error: sync conflict detected >&2
    exit 1
fi

while true; do
    case "$1" in
        -l)
            TOKENIZED=$(sed 's/ /\n/g' "${TODO_FILE}" | sort -u)
            echo "${TOKENIZED}" | grep '^@'
            echo
            echo "${TOKENIZED}" | grep '^+'
            exit
            ;;
        -d)
            shift
            DUE="due:$(date -I)"
            data="$(grep "$DUE" "${TODO_FILE}" | sed "s/$DUE//g" | sort)"
            if [ -t 1 ]; then
                color_opt=always
            else
                color_opt=never
            fi
            for filter in "$@"; do
                data="$(echo "$data" | grep --color="$color_opt" -i "$filter")"
            done
            echo "$data"
            exit
            ;;
        *)
            if [ -n "$1" ]; then
                echo "$(date -I)" "$@" >> "${TODO_FILE}"
            else
                exec "${EDITOR}" "${TODO_FILE}"
            fi
            break
    esac
done
