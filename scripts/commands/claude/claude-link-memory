#!/usr/bin/env -S uv --quiet run --script

import argparse
import os
import pathlib


def main():
    parser = argparse.ArgumentParser(
        description="Symlink CLAUDE.local.md outside repo for persistence"
    )
    parser.add_argument(
        "path",
        type=pathlib.Path,
        nargs="?",
        default=pathlib.Path.cwd(),
        help="Path to create CLAUDE.local.md for (default: cwd)",
    )
    parser.add_argument(
        "--content", "-c", default="", help="Content for the file"
    )
    parser.add_argument(
        "--show-path",
        "-s",
        action="store_true",
        help="Print path of existing memory file (error if not found)",
    )
    default_base = pathlib.Path.home() / ".claude/local-memory"
    parser.add_argument(
        "--base",
        "-b",
        type=pathlib.Path,
        default=os.environ.get("CLAUDE_MEMORY_BASE", default_base),
        help=f"Base directory for storage (default: {default_base})",
    )
    args = parser.parse_args()

    base = pathlib.Path(args.base).expanduser()
    base.mkdir(parents=True, exist_ok=True)
    home = pathlib.Path.home()
    target = args.path.resolve()

    if target.is_relative_to(home):
        rel = target.relative_to(home)
        storage = base / "from_home" / rel / "CLAUDE.local.md"
    else:
        rel = pathlib.Path(*target.parts[1:])
        storage = base / "from_root" / rel / "CLAUDE.local.md"

    if args.show_path:
        if not storage.exists():
            raise SystemExit(f"Error: memory file not found: {storage}")
        print(storage)
        return

    link = target / "CLAUDE.local.md"

    if link.exists() or link.is_symlink():
        if link.is_symlink() and link.resolve() == storage.resolve():
            pass  # already linked correctly
        else:
            raise SystemExit(
                f"Error: {link} exists and is not symlink to {storage}"
            )
    else:
        storage.parent.mkdir(parents=True, exist_ok=True)
        if not storage.exists():
            storage.write_text(args.content)
        link.symlink_to(storage)

    # Also link .claude folder
    claude_dir_storage = storage.parent / ".claude"
    claude_dir_link = target / ".claude"

    if claude_dir_link.exists() or claude_dir_link.is_symlink():
        if (
            claude_dir_link.is_symlink()
            and claude_dir_link.resolve() == claude_dir_storage.resolve()
        ):
            pass  # already linked correctly
        else:
            raise SystemExit(
                f"Error: {claude_dir_link} exists and is not symlink to {claude_dir_storage}"
            )
    else:
        claude_dir_storage.mkdir(parents=True, exist_ok=True)
        claude_dir_link.symlink_to(claude_dir_storage)


if __name__ == "__main__":
    main()
