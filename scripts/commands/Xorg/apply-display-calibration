#!/usr/bin/env sh
set -e

clear_existing_calibration() {
    dispwin -h 2>&1 | grep Output | awk '{print $1}' | xargs -n 1 dispwin -c -d > /dev/null 2>&1
}

show_help() {
    cat << EOF
usage: apply-display-calibration [--help] [--reset]

no args will apply display calibration automatically

    --reset     reset display calibration
    --help      show help and exit
EOF
}


while true; do
    case "$1" in
        --help)
            show_help
            exit
            ;;
        --reset)
            clear_existing_calibration
            exit
            ;;
        *)
            if [ $# -eq 1 ]; then
                PROFILE="$1"
            elif [ $# -eq 0 ]; then
                # xrandr-edid $(xrandr-primary-output) | base64 -w0
                case "$(xrandr-edid "$(xrandr-primary-output)" | base64 -w0)" in
                    # basement - dell u2412m
                    AP///////wAQrHugUzg5MBEXAQSlNCB4Ou6Vo1RMmSYPUFShCACBQIGAqUCzANHAAQEBAQEBKDyAoHCwI0AwIDYABkQhAAAaAAAA/wBZTVlIMTM0TDA5OFMKAAAA/ABERUxMIFUyNDEyTQogAAAA/QAyPR5TEQAKICAgICAgAMk=)
                        PROFILE="$DOTFILES/icc/U2412M #1 2020-11-30 19-46 D6500 sRGB F-S XYZLUT+MTX.icc"
                        ;;
                    # office - LG 34GK950F-B
                    AP///////wAebSd3/aoHAAMdAQS1UCF4n/Z1r05CqyYOUFQlSwBxQIGAgcCpwLMA0cCBANHP53xwoNCgKVAwIDoAIE8xAAAaTqtwuNGgQlCQYGQIIE8xAAAaAAAA/QAwkOHhUAEKICAgICAgAAAA/AAzNEdLOTUwRgogICAgApYCAyhxIwkGB0kQBAMBHxMSBRTjBcAA4wYFAW0aAAACBzCQAARhPmE+TtRwoNCgRlAwIDoAIE8xAAAaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAxnASeQAAAwAo6gUBhm8N3wCPgB8AnwVUAAIACQBmOAGGbw3vAC+AHwCfBUUAAgAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPaQ)
                        PROFILE="$DOTFILES/icc/DisplayPort-0 #1 2020-11-25 18-29 2.2 F-S XYZLUT+MTX.icc"
                        ;;
                    # phobos - xps 13
                    AP///////wBNECEUAAAAADIYAQSlHRF4Dt5Qo1RMmSYPUFQAAAABAQEBAQEBAQEBAQEBAQEBzZGAoMAINHAwIDUAJqUQAAAYAAAAEAAAAAAAAAAAAAAAAAAAAAAA/gAwNVA3SIVMUTEzM1oxAAAAAAACQQMoABIAAAsBCiAgABs=)
                        PROFILE="$DOTFILES/icc/05P7H-LQ133Z1 #1 2020-11-26 13-32 D6500 sRGB VF-S XYZLUT+MTX.icc"
                        ;;
                esac
            else
                show_help
                echo error: unknown arguments >&2
                exit 1
            fi
            break
    esac
done


clear_existing_calibration

echo "Profile: $PROFILE"
dispwin -d1 "$PROFILE" 2> /dev/null
