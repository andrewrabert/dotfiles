#!/usr/bin/env sh
set -e

clear_existing_calibration() {
    dispwin -h 2>&1 | grep Output | awk '{print $1}' | xargs -n 1 dispwin -c -d > /dev/null 2>&1
}

show_help() {
    cat << EOF
usage: apply-display-calibration [--help] [--reset]

no args will apply display calibration automatically

    --reset     reset display calibration
    --help      show help and exit
EOF
}


while true; do
    case "$1" in
        --help)
            show_help
            exit
            ;;
        --reset)
            clear_existing_calibration
            exit
            ;;
        *)
            if [ $# -eq 1 ]; then
                PROFILE="$1"
            elif [ $# -eq 0 ]; then
                case "$(hostname)" in
                    "mars")
                        case "$(xrandr-primary-output)" in
                            DisplayPort-0)
                                PROFILE="$DOTFILES/icc/DisplayPort-0 #1 2020-11-25 18-29 2.2 F-S XYZLUT+MTX.icc"
                                ;;
                            DisplayPort-1)
                                PROFILE="$DOTFILES/icc/dell_u2412m_custom.icc"
                                ;;
                        esac
                        ;;
                    "phobos")
                        PROFILE="$DOTFILES/icc/xps13_phobos.icc"
                        ;;
                    "apollo")
                        PROFILE="$DOTFILES/icc/surface_go.icc"
                        ;;
                    *)
                        echo 'error: missing profile' >&2
                        exit 1
                esac
            else
                show_help
                echo error: unknown arguments >&2
                exit 1
            fi
            break
    esac
done


clear_existing_calibration

dispwin -d1 "$PROFILE"
