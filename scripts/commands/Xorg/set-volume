#!/usr/bin/env sh
notify() {
    dunstify \
        --hints=string:x-dunst-stack-tag:set-volume \
        --hints=int:transient:1 \
        'Volume' "$@"
}

round_to_5() {
    python -c 'import sys; volume=int(sys.argv[1]); sys.stdout.write(str(int(volume / 5)*5))' "$1"
}


change_pamixer() {
    case "$1" in
        toggle-mute)
            res="$(pamixer --get-mute --get-volume --toggle-mute)"
            ;;
        output-up)
            res="$(pamixer --get-mute --get-volume --unmute --increase 5)"
            ;;
        output-down)
            res="$(pamixer --get-mute --get-volume --unmute --decrease 5)"
            ;;
        *)
            echo 'error: unexpected arguments' >&2
            exit 1
    esac

    set -- $res
    MUTED="$1"
    VOLUME="$2"

    case "$VOLUME" in
        5|0)
            ;;
        *)
            VOLUME="$(round_to_5 "$VOLUME")"
            pamixer --set-volume "$VOLUME"
            ;;
    esac

    case "$MUTED" in
        true)
            notify ğŸ”‡
            ;;
        *)
            notify -h "int:value:${VOLUME}"
            ;;
    esac
}

change_hass() {
    case "$1" in
        toggle-mute)
            hass office-tv-mute-toggle
            ;;
        output-up)
            hass office-tv-volume-up
            ;;
        output-down)
            hass office-tv-volume-down
            ;;
        *)
            echo 'error: unexpected arguments' >&2
            exit 1
    esac
}

case "$(pamixer --get-default-sink)" in
    *alsa_output.pci-0000_0b_00.1.hdmi-stereo*)
        change_hass "$@"
        ;;
    *)
        change_pamixer "$@"
esac
