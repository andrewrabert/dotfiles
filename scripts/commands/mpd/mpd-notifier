#!/usr/bin/env python
import pathlib
import subprocess

import mpd

LIBRARY = pathlib.Path('~/Audio/Lossy_opus_128').expanduser()
if not LIBRARY.exists():
    LIBRARY = pathlib.Path('/storage/Audio/Library')


def _dunstify(text, icon=None):
    args = [
        'dunstify',
        'mpd',
        text,
        '--hints=string:x-dunst-stack-tag:mpd-notifier',
        '--appname', 'mpd-notifier',
    ]
    if icon:
        args.extend(['--icon', str(icon)])
    subprocess.run(args, check=True)


client = mpd.MPDClient()
client.timeout = 5
client.connect('localhost', 6600)

while True:
    status = client.status()
    event = client.idle()
    new_status = client.status()

    if new_status['state'] == 'stop':
        if status['state'] == 'play':
            _dunstify('[stopped]')
        continue

    if status.get('songid') == new_status.get('songid'):
        if status['state'] == new_status['state']:
            if new_status['time'].split(':')[0] != '0':
                continue

    current = client.currentsong()
    if not current:
        continue

    art_path = None
    for path in LIBRARY.joinpath(current['file']).parent.iterdir():
        if path.name in ('cover.jpg', 'cover.png'):
            art_path = path
            break

    if new_status['state'] == 'pause':
        _dunstify(
            '[paused]',
            icon=art_path)
    else:
        _dunstify(
            '<b>{}</b>\n{}'.format(current['title'], current['artist']),
            icon=art_path)

client.close()
client.disconnect()
