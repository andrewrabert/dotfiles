#!/usr/bin/env sh

# Parse flags
DISABLE_TMUX_CHECK=false
SET_WINDOW_OPTIONS=false
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            echo "ssh-tmux-attach - SSH with tmux session management"
            echo ""
            echo "USAGE:"
            echo "    ssh-tmux-attach [OPTIONS] SSH_HOST"
            echo ""
            echo "OPTIONS:"
            echo "    -c, --current-pane      Open in current tmux pane (when in tmux session)"
            echo "        --current-window    Open in current tmux window and set window name/options"
            echo "    -h, --help              Show this help message"
            exit 0
            ;;
        -c|--current-pane)
            DISABLE_TMUX_CHECK=true
            shift
            ;;
        --current-window)
            DISABLE_TMUX_CHECK=true
            SET_WINDOW_OPTIONS=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo 'usage: [-c|--current-pane] [--current-window] [-h|--help] SSH_HOST' >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [ $# -ne 1 ]; then
    echo 'usage: [-c|--current-pane] [--current-window] [-h|--help] SSH_HOST' >&2
    exit 1
fi
SSH_HOST="$1"

# Check if we're inside a tmux session and tmux handling is enabled
if [ -n "$TMUX" ] && [ "$DISABLE_TMUX_CHECK" = false ]; then
    # Create new tab with name "ssh <host>" and set @renamed
    case "$SSH_HOST" in
        mars|phobos|lounge-htpc)
            tmux new-window -n "ssh $SSH_HOST" "ssh -t '$SSH_HOST' -- systemd-inhibit --who='ssh-tmux-attach' --what=idle --mode=block zsh -lic tmux-attach"
            ;;
        *)
            tmux new-window -n "ssh $SSH_HOST" "ssh -t '$SSH_HOST' -- zsh -lic tmux-attach"
    esac
    tmux set-window-option @renamed on
    tmux set-window-option @nested_mode on
else
    # Set window options if requested
    if [ "$SET_WINDOW_OPTIONS" = true ]; then
        tmux rename-window "ssh $SSH_HOST"
        tmux set-window-option @renamed on
        tmux set-window-option @nested_mode on
    fi

    # Direct SSH connection
    case "$SSH_HOST" in
        mars|phobos|lounge-htpc)
            exec ssh -t "${SSH_HOST}" -- systemd-inhibit --who='ssh-tmux-attach' --what=idle --mode=block zsh -lic tmux-attach
            ;;
        *)
            exec ssh -t "${SSH_HOST}" -- zsh -lic tmux-attach
    esac
fi
