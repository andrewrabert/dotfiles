#!/usr/bin/env sh

# Parse flags
ENABLE_TMUX_CHECK=false
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            echo "ssh-tmux-attach - SSH with tmux session management"
            echo ""
            echo "USAGE:"
            echo "    ssh-tmux-attach [OPTIONS] SSH_HOST"
            echo ""
            echo "OPTIONS:"
            echo "    -n, --new-tab        Create new tmux tab (when in tmux session)"
            echo "    -h, --help           Show this help message"
            echo ""
            echo "DESCRIPTION:"
            echo "    Connects directly via SSH by default."
            echo "    When run with -n flag inside a tmux session, creates a new tab named 'ssh <host>'."
            echo ""
            echo "    Special hosts (mars, phobos, lounge-htpc) use systemd-inhibit."
            exit 0
            ;;
        -n|--new-tab)
            ENABLE_TMUX_CHECK=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo 'usage: [-n|--new-tab] [-h|--help] SSH_HOST' >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [ $# -ne 1 ]; then
    echo 'usage: [-n|--new-tab] [-h|--help] SSH_HOST' >&2
    exit 1
fi
SSH_HOST="$1"

# Check if we're inside a tmux session and tmux handling is enabled
if [ -n "$TMUX" ] && [ "$ENABLE_TMUX_CHECK" = true ]; then
    # Create new tab with name "ssh <host>" and set @renamed
    case "$SSH_HOST" in
        mars|phobos|lounge-htpc)
            tmux new-window -n "ssh $SSH_HOST" "ssh -t '$SSH_HOST' -- systemd-inhibit --who='ssh-tmux-attach' --what=idle --mode=block zsh -lic tmux-attach"
            tmux set-window-option @renamed on
            ;;
        *)
            tmux new-window -n "ssh $SSH_HOST" "ssh -t '$SSH_HOST' -- zsh -lic tmux-attach"
            tmux set-window-option @renamed on
    esac
else
    # Default behavior - direct SSH connection
    case "$SSH_HOST" in
        mars|phobos|lounge-htpc)
            exec ssh -t "${SSH_HOST}" -- systemd-inhibit --who='ssh-tmux-attach' --what=idle --mode=block zsh -lic tmux-attach
            ;;
        *)
            exec ssh -t "${SSH_HOST}" -- zsh -lic tmux-attach
    esac
fi
