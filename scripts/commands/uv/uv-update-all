#!/usr/bin/env python3
"""Update all PEP 723 scripts managed by uv in a directory."""

import argparse
import asyncio
import pathlib
import sys


def all_files(*paths):
    stack = []
    files = set()
    for path in paths:
        if not path.exists():
            raise ValueError(f"path does not exist: {path}")
        elif path.is_file():
            files.add(path)
        elif path.is_dir():
            stack.append(path)
    while stack:
        for path in stack.pop().iterdir():
            if path.is_dir():
                stack.append(path)
            else:
                files.add(path)
    return sorted(files)


async def find_uv_scripts(directory: pathlib.Path) -> list[pathlib.Path]:
    """Find all executable files with uv run shebang."""
    uv_scripts = []

    for file_path in all_files(directory):
        with open(file_path, "r") as handle:
            try:
                parts = handle.readline().strip().split()
            except UnicodeDecodeError:
                continue
            if (
                parts[0] == "#!/usr/bin/env"
                and "uv" in parts
                and "run" in parts
            ):
                uv_scripts.append(file_path.resolve().absolute())
    return sorted(set(uv_scripts))


async def update_script(script_path: pathlib.Path) -> bool:
    """Update dependencies for a single PEP 723 script."""
    try:
        proc = await asyncio.create_subprocess_exec(
            "uv",
            "run",
            "--script",
            "--upgrade",
            "--quiet",
            str(script_path),
            "--help",
            stdout=asyncio.subprocess.DEVNULL,
            stderr=asyncio.subprocess.DEVNULL,
        )
        await proc.wait()
        return proc.returncode == 0
    except Exception:
        return False


async def update_all_scripts(scripts: list[pathlib.Path]) -> bool:
    """Update all scripts concurrently."""
    tasks = []
    for script in scripts:
        task = asyncio.create_task(update_script(script))
        tasks.append((script, task))

    had_error = False

    for script, task in tasks:
        script_name = script.name
        try:
            success = await task
            if success:
                print(f"updated: {script_name}")
            else:
                print(f"failed: {script_name}")
                had_error = True
        except Exception:
            print(f"failed: {script_name}")
            had_error = True

    return had_error


async def main():
    """Main function."""
    parser = argparse.ArgumentParser(description="update all PEP 723 scripts")
    parser.add_argument(
        "directory",
        nargs="?",
        default=".",
        type=pathlib.Path,
        help="directory to scan",
    )
    args = parser.parse_args()

    scripts = await find_uv_scripts(args.directory)

    had_error = False
    if scripts:
        had_error = await update_all_scripts(scripts)

    if had_error:
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())
