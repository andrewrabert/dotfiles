#!/bin/bash
EDITOR="$EDITOR -n"
SESSION=$(uuidgen)

trap "tmux kill-session -t $SESSION 2> /dev/null" SIGHUP
trap "tmux kill-session -t $SESSION 2> /dev/null" EXIT

if [[ $(tmux display-message -p '#S' 2> /dev/null) == $TMUX_SESSION ]]; then
    if [[ $1 == '-p' ]]; then
        PYTHON_BIN=$2
        shift
        shift
    elif [[ -n $VIRTUAL_ENV ]]; then
        PYTHON_BIN=python
    else
        PYTHON_BIN=python3
    fi

    if [[ -z $1 ]]; then
        LMK_FILE=$(mktemp --suffix='.py')
        trap "rm -f "$LMK_FILE"" EXIT
        mkdir -p "$(dirname "$LMK_FILE")"
        touch "$LMK_FILE"
    else
        LMK_FILE="$1"
    fi

    cd $(dirname "$LMK_FILE")
    if [[ -n $VIRTUAL_ENV ]]; then
        tmux split-window -h "VIRTUAL_ENV="$VIRTUAL_ENV" lmk $PYTHON_BIN $LMK_FILE"
    else
        tmux split-window -h "lmk $PYTHON_BIN $LMK_FILE"
    fi

    tmux select-pane -l
    $EDITOR $LMK_FILE
    tmux kill-session -t $SESSION
else
    unset TMUX

    if [[ -n $VIRTUAL_ENV ]]; then
        tmux new-session -d -s $SESSION "TMUX_SESSION="$SESSION" VIRTUAL_ENV="$VIRTUAL_ENV" $0 "$@""
    else
        tmux new-session -d -s $SESSION $0 "$@"
    fi
    tmux set-option -t $SESSION status off
    tmux attach-session -t $SESSION > /dev/null
fi
