#!/bin/bash
set -e

GOG_DIR=/mnt/storage1/Games/PC/GOG.com
CONTAINER_GOG_DIR=/downloads
ORPHANS_FILE=/tmp/gog-update-orphans
DOCKER_IMAGE=nvllsvm/lgogdownloader

lgogdownloader() {
    docker run \
        --rm \
        -e PUID=1000 \
        -e PGID=100 \
        -v $GOG_DIR:/$CONTAINER_GOG_DIR \
        -v ~/.cache/lgogdownloader:/cache \
        -v ~/Code/Private/dotfiles-private/lgogdownloader:/config \
        $DOCKER_IMAGE "$@"
}

docker pull $DOCKER_IMAGE > /dev/null

lgogdownloader --update-check
lgogdownloader --download --save-serials

grep_gog() {
    grep "^$CONTAINER_GOG_DIR" || true
}

ORPHANS=$(lgogdownloader --check-orphans | grep_gog)
if [[ -z "${ORPHANS}" ]]; then
    rm -rf "${ORPHANS_FILE}"
else
    echo "${ORPHANS}" > "${ORPHANS_FILE}"
fi
