#!/usr/bin/env bash
set -e

DATABASE=sol
DATABASE_DIR="/var/cache/pacman/$DATABASE"
DATABASE_FILE="$DATABASE_DIR/$DATABASE.db.tar"

AURVCS='.*-(bzr|git|hg|svn)$'

if ! [ -f "$DATABASE_FILE" ]; then
    repo-add "$DATABASE_FILE"
fi

repotool_update() {
    rm -rf ~/.cache/aurutils/sync/
    sudo pacsync "$DATABASE" > /dev/null

    aur sync --no-view --no-confirm --database="$DATABASE" --no-ver --upgrades

    vcs_pkgs=$(aur repo --database="$DATABASE" --list | cut -f1 | grep -E "$AURVCS" || true)
    if [ -n "$vcs_pkgs" ]; then
        # init vcs sync cache
        aur sync "$vcs_pkgs" --no-ver-argv --no-build --no-view

        mapfile -t git_outdated < <(aur vercmp-devel --database="$DATABASE" | cut -d: -f1)
        if [ ${#git_outdated[@]} -gt 0 ]; then
            repotool_remove "${git_outdated[@]}"
            repotool_add "${git_outdated[@]}"
        fi
    fi

    sudo pacsync "$DATABASE" > /dev/null
    paccache --remove --keep 1 --cachedir "$DATABASE_DIR"
    rm -rf ~/.cache/aurutils/sync/
}

repotool_add() {
    sudo pacsync "$DATABASE" > /dev/null
    for i in "${@}"; do
        if [ -f "$i" ]; then
            sudo cp "$i" "$DATABASE_DIR"
            repo-add "$DATABASE_FILE" "$i"
        else
            packages_and_deps="$packages_and_deps $i $(echo "$i" | aur depends 2>/dev/null | cut -f2 | sort | comm -12 - <(aur pkglist | sort))"
        fi
    done
    if [ -n "$packages_and_deps" ]; then
        aur sync --no-view --no-confirm --no-ver --database="$DATABASE" -- ${packages_and_deps} || true
    fi
    sudo pacsync "$DATABASE" > /dev/null
    for i in "${@}"; do
        if ! [ -f "$i" ]; then
            pacman -Si "sol/$i" >&2 || true
        fi
    done
}

repotool_remove() {
    repo-remove "$DATABASE_FILE" "${@}"
    for pkg in "${@}"; do
        rm -rf "$DATABASE_DIR"/"$pkg"*.pkg.*
    done
    sudo pacsync "$DATABASE" > /dev/null
}

sync_nullsum() {
    cp /var/cache/pacman/sol/sol.db.tar \
       /var/cache/pacman/sol/sol.db
    cp /var/cache/pacman/sol/sol.files.tar \
       /var/cache/pacman/sol/sol.files
    rsync -av --progress --delete /var/cache/pacman/sol/ nullsum.net:~/r/arch/x86_64
}

usage() {
    cat << EOF
usage: sol-repotool (add|remove|update)
EOF
}

case "$1" in
    update)
        shift
        repotool_update "$@"
        sync_nullsum
        exit
        ;;
    add)
        shift
        repotool_add "$@"
        sync_nullsum
        exit
        ;;
    remove)
        shift
        repotool_remove "$@"
        sync_nullsum
        exit
        ;;
    --help)
        usage
        exit
        ;;
    *)
        usage >&2
        exit 1
esac
