#!/usr/bin/env sh
set -e
IMAGE=nvllsvm/harmonize

SOURCE=/storage/Audio/Library
TARGET=/storage/Audio/Lossy_opus_128

harmonize() {
    podman run \
        --rm \
        --pull always \
        --quiet \
        --userns= \
        -v "$SOURCE:$SOURCE" \
        -v "$TARGET:$TARGET" \
        "$IMAGE" "$@"
}

harmonize -n 8 "$SOURCE" "$TARGET" --codec opus --bitrate 128 --music

printf 'Updating Airsonic library .'
gonic-cli startScan > /dev/null

while [ "$(gonic-cli getScanStatus | jq '.scanning')" = 'true' ]; do
    printf .
    sleep 1
done
echo ' Done'
