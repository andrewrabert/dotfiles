#!/usr/bin/env sh

# Single-instance enforcement
exec 9>/tmp/lounge-htpc-cli.lock
flock -n 9 || { echo "Another instance is already running" >&2; exit 1; }

http_request() {
    curl -X POST -v "http://127.0.0.1${1}"
}

is_power_off() {
    [ "$(curl -s http://127.0.0.1/status | jq -r .power)" = "off" ]
}

is_playing() {
    [ "$(playerctl status 2>/dev/null)" = "Playing" ]
}

case "$1" in
    brightness-max)
        http_request /brightness/max
        ;;
    brightness-min)
        http_request /brightness/min
        ;;
    volume-up)
        http_request /volume/up
        ;;
    volume-down)
        http_request /volume/down
        ;;
    volume-mute-toggle)
        http_request /mute/toggle
        ;;
    power-toggle)
        if is_power_off; then
            http_request /power/toggle
            playerctl play
        else
            playerctl pause
            http_request /power/toggle
        fi
        ;;
    picture-toggle)
        if is_playing; then
            http_request /picture/toggle
        else
            http_request /power/toggle
        fi
        ;;
    *)
        echo 'usage: (picture-toggle|power-toggle|volume-up|volume-down|volume-mute-toggle)' >&2
        exit 1
esac
