# Free the original Ctrl-b prefix keybinding
unbind C-b

# Setting the prefix from C-b to C-a
set -g prefix C-a

# Setting the delay between prefix and command
set -s escape-time 1

# Ensure that we can send Ctrl-a to other apps
bind C-a send-prefix

# Send prefix to nested tmux with Alt+a
bind -n M-a send-keys C-a

# history buffer - max number of lines for each window
set -g history-limit 50000

# Set the base index for windows to 1 instead of 0
set -g base-index 1

# Set the base index for panes to 1 instead of 0
setw -g pane-base-index 1

# Reload the file with Prefix r
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Run SSH with fzf host selection (only if ssh-tmux-attach exists)
if-shell "command -v ssh-tmux-attach >/dev/null 2>&1" \
    "bind -n M-r new-window 'tmux-ssh-fzf'"

# Splitting panes replace % and "
bind s split-window -v -c '#{?pane_path,#{pane_path},#{pane_current_path}}'
bind v split-window -h -c '#{?pane_path,#{pane_path},#{pane_current_path}}'
bind -n M-s if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-s' 'split-window -v -c "#{?pane_path,#{pane_path},#{pane_current_path}}"'
bind -n M-v if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-v' 'split-window -h -c "#{?pane_path,#{pane_path},#{pane_current_path}}"'

# New window with current path
bind C new-window -c '#{?pane_path,#{pane_path},#{pane_current_path}}'
#bind -n M-C new-window -c '#{?pane_path,#{pane_path},#{pane_current_path}}'

# New window
#bind -n M-c if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-c' 'new-window'
bind -n M-C 'send-keys M-c'
bind -n M-c new-window

# Change windows
bind -n M-N 'send-keys M-n'
bind -n M-P 'send-keys M-p'
bind -n M-n next-window
bind -n M-p previous-window

# Zoom active window
bind -n M-z if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-z' 'resize-pane -Z'

# Rename window
bind -n M-, if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-,' \
    'if-shell "[ \"#{@renamed}\" = \"on\" ]" \
        "command-prompt -p \"name:\" -I \"#W\" \
            \"if-shell \\\"[ -n \\\\\\\"%1\\\\\\\" ]\\\" \
                \\\"rename-window \\\\\\\"%1\\\\\\\"; set-window-option automatic-rename off; set-window-option @renamed on\\\" \
                \\\"set-window-option automatic-rename on; set-window-option -u @renamed\\\"\"" \
        "command-prompt -p \"name:\" \
            \"if-shell \\\"[ -n \\\\\\\"%1\\\\\\\" ]\\\" \
                \\\"rename-window \\\\\\\"%1\\\\\\\"; set-window-option automatic-rename off; set-window-option @renamed on\\\" \
                \\\"set-window-option automatic-rename on; set-window-option -u @renamed\\\"\""'

# Rename window with prefix+comma (same functionality as Alt+comma)
bind , if-shell '[ "#{@renamed}" = "on" ]' \
    'command-prompt -p "name:" -I "#W" \
        "if-shell \"[ -n \\\"%1\\\" ]\" \
            \"rename-window \\\"%1\\\"; set-window-option automatic-rename off; set-window-option @renamed on\" \
            \"set-window-option automatic-rename on; set-window-option -u @renamed\""' \
    'command-prompt -p "name:" \
        "if-shell \"[ -n \\\"%1\\\" ]\" \
            \"rename-window \\\"%1\\\"; set-window-option automatic-rename off; set-window-option @renamed on\" \
            \"set-window-option automatic-rename on; set-window-option -u @renamed\""'

# kill pane without confirmation
bind x kill-pane
bind -n M-q if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-q' 'kill-pane'

# kill window
bind q kill-window

# moving between panes
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind -n M-h if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-h' 'select-pane -L'
bind -n M-j if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-j' 'select-pane -D'
bind -n M-k if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-k' 'select-pane -U'
bind -n M-l if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-l' 'select-pane -R'

# Moving Panes
bind -n C-M-j if-shell -F '#{?@nested_mode,1,0}' 'send-keys C-M-j' 'swap-pane -D'
bind -n C-M-k if-shell -F '#{?@nested_mode,1,0}' 'send-keys C-M-k' 'swap-pane -U'
bind -n M-m if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-m' 'swap-pane -t !'

# Quick pane selection
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

bind -n M-0 select-window -t 0
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5
bind -r C-H resize-pane -L 1
bind -r C-J resize-pane -D 1
bind -r C-K resize-pane -U 1
bind -r C-L resize-pane -R 1
bind -r -n M-H if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-H' 'resize-pane -L 5'
bind -r -n M-J if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-J' 'resize-pane -D 5'
bind -r -n M-K if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-K' 'resize-pane -U 5'
bind -r -n M-L if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-L' 'resize-pane -R 5'

# Mouse support
set -g mouse on

# tmux coloring
# Set the status line's colors
set -g status-style fg=white,bg=black

# Set the color of the window list
setw -g window-status-style fg=cyan,bg=default,dim

# Set colors for the active window
setw -g window-status-current-style fg=white,bg=red,bright

# Pane colors
set -g pane-border-style fg=brightblack
set -g pane-active-border-style fg=brightwhite

# Command / message line
set -g message-style fg=white,bg=black,bright

set -g status-left-length 15
set -g status-left "#{?HOST_DOTFILES,#{HOST_DOTFILES},#{host}}"
set -g status-right "#[fg=white]%Y-%m-%d %R"

# Update the status bar every sixty seconds
set -g status-interval 60

# Center the window list
set -g status-justify centre

# Enable vi keys
setw -g mode-keys vi

# synchronize panes
bind e set-window-option synchronize-panes
bind -n M-e set-window-option synchronize-panes

# nested mode (pass through hotkeys to nested session)
bind t if-shell -F '#{?@nested_mode,1,0}' 'set-window-option -u @nested_mode' 'set-window-option @nested_mode on'
bind -n M-t if-shell -F '#{?@nested_mode,1,0}' 'set-window-option -u @nested_mode' 'set-window-option @nested_mode on'

set-option -gw window-status-format ' #{?pane_synchronized,#[default],}#I#{?@renamed,:#W,} '
set-option -gw window-status-current-format ' #{?pane_synchronized,#[default],}#I#{?@renamed,:#W,} #[bg=brightblack]#[fg=white] #F #{?pane_synchronized,#[fg=yellow]SYNC #[default],}#{?@nested_mode,#[fg=green]TMUX #[default],}'
set-option -gw window-status-current-style fg=black,bg=white
set-option -gw window-status-style fg=white

# send pane to window
bind @ command-prompt -p "send pane to:" "join-pane -t ':%%'"

# copy-mode
bind -n M-Escape copy-mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X end-selection
bind-key -T copy-mode-vi MouseDown3Pane send-keys -X cancel
bind-key -T copy-mode-vi y send-keys -X copy-selection \; send-keys -X clear-selection
bind-key -T copy-mode-vi p { send-keys -X cancel; refresh-client -l; run -d0.1; paste-buffer }
bind -n M-] { refresh-client -l; run -d0.1; paste-buffer }
bind-key -T copy-mode-vi Escape send-keys -X cancel

# disable right click menu
unbind-key -T root MouseDown3Pane

# focus events
set -g focus-events on

# allow setting base16-shell themes (ex. via `. ~/.base16_theme
set -g allow-passthrough on

# OSC52 clipboard support
set -s set-clipboard on
# 10MB max for clipboard
set -s input-buffer-size 10485760

# fix base16-shell themes in neovim
set -g default-terminal "tmux-256color"
set-option -sa terminal-features ',foot:RGB'
set-option -sa terminal-features ',alacritty:RGB'
set-option -sa terminal-features ',xterm-256color:RGB'
set-option -sa terminal-features ',xterm-ghostty:RGB'

# Pass Ctrl+Alt+<key> combinations to nested sessions as Alt+<key>
bind -n C-M-h send-keys M-h
bind -n C-M-l send-keys M-l
bind -n C-M-s send-keys M-s
bind -n C-M-v send-keys M-v
bind -n C-M-C send-keys M-C
bind -n C-M-0 send-keys M-0
bind -n C-M-1 send-keys M-1
bind -n C-M-2 send-keys M-2
bind -n C-M-3 send-keys M-3
bind -n C-M-4 send-keys M-4
bind -n C-M-5 send-keys M-5
bind -n C-M-6 send-keys M-6
bind -n C-M-7 send-keys M-7
bind -n C-M-8 send-keys M-8
bind -n C-M-9 send-keys M-9
bind -n C-M-m send-keys M-m
bind -n C-M-e send-keys M-e
bind -n C-M-Escape send-keys M-Escape
bind -n C-M-] send-keys M-]
bind -n C-M-Space send-keys M-Space

# Cycle through pane layouts
bind -n M-Space if-shell -F '#{?@nested_mode,1,0}' 'send-keys M-Space' 'next-layout'
