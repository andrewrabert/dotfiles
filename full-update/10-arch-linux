#!/usr/bin/env sh
set -e

if ! command -v pacman > /dev/null; then
    exit
fi

MAGENTA='\033[1;35m'
YELLOW='\033[1;33m'
RESET='\033[0m'

export PKGEXT='.pkg.tar'

# Parse flags
UPDATE_AUR=false
for arg in "$@"; do
    if [ "$arg" = "--aur" ]; then
        UPDATE_AUR=true
    fi
done

log() {
    printf "${MAGENTA}$1 ...${RESET}\n"
}

warn() {
    printf "${YELLOW}$1${RESET}\n"
}

if ! [ -d ~/.config/pacman ] || [ "$(realpath ~/.config/pacman)" != "${DOTFILES}/pacman" ]; then
    rm -rf ~/.config/pacman
    mkdir -p ~/.config/
    ln -sfT "${DOTFILES}/pacman" ~/.config/pacman
fi

KEY_ID="952DF315E396E06A"
if ! pacman-key --list-keys "$KEY_ID" > /dev/null 2>&1; then
    log 'Adding personal GPG key to pacman keyring'
    sudo pacman-key --add /etc/pacman.d/ar.asc
    sudo pacman-key --lsign-key "$KEY_ID"
fi

if ! command -v yay > /dev/null 2>&1; then
    mkdir /tmp/yay-install
    trap 'rm -rf /tmp/yay-install' INT EXIT
    cd /tmp/yay-install
    curl https://aur.archlinux.org/cgit/aur.git/snapshot/yay.tar.gz | tar -zxv
    cd -
    cd /tmp/yay-install/yay
    makepkg -s --install --noconfirm
    rm -rf /tmp/yay-install
    cd -
fi

log 'Updating repository packages'
sudo pacman -Syu --noconfirm

# Check for AUR updates
if command -v yay > /dev/null 2>&1; then
    log 'Checking for AUR updates'
    AUR_PACKAGE_LIST=$(yay -Qua 2>/dev/null | sort)
    AUR_UPDATES=$(echo "$AUR_PACKAGE_LIST" | grep -v '^$' | wc -l)

    if [ "$AUR_UPDATES" -gt 0 ]; then
        if [ "$UPDATE_AUR" = true ]; then
            log "Updating $AUR_UPDATES AUR packages"
            yay -Sua --noconfirm --devel
        else
            warn "⚠️  $AUR_UPDATES AUR package(s) have updates available:"
            echo "$AUR_PACKAGE_LIST"
            warn "Run with --aur flag to update them."
        fi
    else
        log 'No AUR updates available'
    fi
fi

if command -v pkgfile > /dev/null; then
    log 'Updating file cache'
    sudo pkgfile --update > /dev/null
fi

# TODO create prune script which keeps n-number of old versions of a package
if command -v paccache > /dev/null; then
    log 'Pruning package cache'
    paccache \
        --remove \
        --keep 3 \
        --min-mtime '30 days ago'
fi

log 'Locating .pac* files'
sudo rm -f /etc/pacman.d/mirrorlist.pacnew
sudo find /etc -regextype posix-extended -regex ".+\.pac(new|save)" 2> /dev/null || true
