#!/usr/bin/env python3
import asyncio
import dataclasses
import os
import pathlib
import shutil
import subprocess


@dataclasses.dataclass
class GlobalShortcut:
    name: str
    exec: str
    shortcut: str

    @property
    def desktop_id(self):
        command = self.exec.split()[0]
        basename = pathlib.Path(command).name
        return basename


HOSTNAME = os.environ["HOST_DOTFILES"]

HOME = pathlib.Path("~").expanduser()
CONFIG = HOME / ".config"
LOCAL_SHARE = HOME / ".local" / "share"

DOTFILES = pathlib.Path(os.environ["DOTFILES"])

if DOTFILES_PRIVATE := os.environ.get("DOTFILES_PRIVATE", None):
    DOTFILES_PRIVATE = pathlib.Path(DOTFILES_PRIVATE)

LINKS = {
    LOCAL_SHARE / "icons": DOTFILES / "kde" / "icons",
    LOCAL_SHARE / "applications": DOTFILES / "kde" / "applications",
    LOCAL_SHARE / "kwin": DOTFILES / "kde" / "kwin",
}

if DOTFILES_PRIVATE is not None:
    LINKS.update(
        {
            LOCAL_SHARE / "kf6" / "searchproviders": DOTFILES_PRIVATE
            / "kde"
            / "searchproviders",
        }
    )


match HOSTNAME:
    case "mars":
        LINKS.update(
            {
                CONFIG / "autostart": DOTFILES / "kde" / "autostart" / "mars",
            }
        )
    case "phobos":
        LINKS.update(
            {
                CONFIG / "autostart": DOTFILES
                / "kde"
                / "autostart"
                / "phobos",
            }
        )


def delete(path):
    if path.is_symlink() or path.is_file():
        path.unlink(missing_ok=True)
    elif path.is_dir():
        shutil.rmtree(path)


def is_linked(source, target):
    return source.is_symlink() and source.readlink() == target


def symlink(source, target):
    if not is_linked(source, target):
        delete(source)
        source.parent.mkdir(exist_ok=True, parents=True)
        source.symlink_to(target)


class Rsync:
    @staticmethod
    async def copy_into_replace_contents(source, target):
        target.mkdir(exist_ok=True, parents=True)
        proc = await asyncio.create_subprocess_exec(
            "rsync", "-avq", "--delete", f"{source}/", str(target)
        )
        await proc.wait()
        if proc.returncode != 0:
            raise subprocess.CalledProcessError(proc.returncode, "rsync")

    @staticmethod
    async def copy_replace(source, target):
        target.parent.mkdir(exist_ok=True, parents=True)
        proc = await asyncio.create_subprocess_exec(
            "rsync", "-avq", str(source), str(target)
        )
        await proc.wait()
        if proc.returncode != 0:
            raise subprocess.CalledProcessError(proc.returncode, "rsync")


async def update_desktop_database():
    proc = await asyncio.create_subprocess_exec("update-desktop-database")
    await proc.wait()
    if proc.returncode != 0:
        raise subprocess.CalledProcessError(
            proc.returncode, "update-desktop-database"
        )


async def kwriteconfig6(
    *,
    delete=False,
    file=None,
    groups=None,
    key=None,
    notify=False,
    value_type=None,
    value=None,
):
    args = ["kwriteconfig6"]
    if file is not None:
        args.extend(("--file", file))
    if groups is not None:
        if isinstance(groups, str):
            groups = [groups]
        for group in groups:
            args.extend(("--group", group))
    if key is not None:
        args.extend(("--key", key))
    if value_type is not None:
        args.extend(("--type", value_type))
    if delete:
        args.append("--delete")
    if notify:
        args.append("--notify")
    if not delete and value:
        args.append(value)
    if value is not None:
        args.append(value)
    proc = await asyncio.create_subprocess_exec(*args)
    await proc.wait()
    if proc.returncode != 0:
        raise subprocess.CalledProcessError(proc.returncode, "kwriteconfig6")


async def kreadconfig6(*, file=None, groups=None, key=None, default=None):
    args = ["kreadconfig6"]
    if file is not None:
        args.extend(("--file", file))
    if groups is not None:
        if isinstance(groups, str):
            groups = [groups]
        for group in groups:
            args.extend(("--group", group))
    if key is not None:
        args.extend(("--key", key))
    if default is not None:
        args.extend(("--default", default))
    proc = await asyncio.create_subprocess_exec(
        *args,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    stdout, stderr = await proc.communicate()
    if proc.returncode != 0:
        raise subprocess.CalledProcessError(proc.returncode, "kreadconfig6")
    return stdout.decode().strip()


def write_desktop_file(name, exec, desktop_id):
    """Write a .desktop file for global shortcut."""
    desktop_file = (
        LOCAL_SHARE
        / "applications"
        / f"net.local.dotfiles.{desktop_id}.desktop"
    )
    desktop_content = f"""[Desktop Entry]
Exec={exec}
Name={name}
NoDisplay=true
StartupNotify=false
Type=Application
X-KDE-GlobalAccel-CommandShortcut=true
"""
    desktop_file.parent.mkdir(parents=True, exist_ok=True)
    desktop_file.write_text(desktop_content)


async def configure_kde():
    settings = {
        "kwinrc": {
            "Plugins": {
                "dialogparentEnabled": "false",
            }
        },
        "kdesurc": {
            "super-user-command": {
                "super-user-command": "sudo",
            }
        },
        "kuriikwsfilterrc": {
            "General": {
                "DefaultWebShortcut": "google",
                "EnableWebShortcuts": "true",
                "KeywordDelimiter": ":",
                "PreferredWebShortcuts": "google,youtube,wikit,yahoo,wikipedia",
                "UsePreferredWebShortcutsOnly": "false",
            }
        },
        "dolphinrc": {
            "KDE": {
                "AnimationDurationFactor": "0",
            },
            "MainWindow": {
                "MenuBar": "Disabled",
            },
            "General": {
                "OpenNewTabAfterLastTab": "true",
                "ShowFullPath": "true",
            },
        },
        "kglobalshortcutsrc": {
            "kwin": {
                "Window Above Other Windows": "Meta+A,,Keep Window Above Others",
                "Window Fullscreen": "Meta+Shift+F,,Make Window Fullscreen",
                "Window Maximize": "Meta+PgUp\tMeta+F,Meta+PgUp,Maximize Window",
                "Window Move Center": "Meta+C,,Move Window to the Center",
            },
        },
    }

    kglobalshortcuts_nested = {
        "plasmashell": {
            "activate application launcher": "Alt+F1,Meta\tAlt+F1,Activate Application Launcher",
        },
        ("services", "org.kde.krunner.desktop"): {
            "_launch": "Search\tAlt+F2\tMeta+Space",
        },
    }

    settings_nested_groups = {
        "kglobalshortcutsrc": kglobalshortcuts_nested,
    }

    global_shortcuts = []

    match HOSTNAME:
        case "lounge-htpc":
            global_shortcuts.extend(
                [
                    GlobalShortcut(
                        name="Lounge HTPC Brightness Max",
                        exec="lounge-htpc-brightness-max.sh",
                        shortcut="Back",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Brightness Min",
                        exec="lounge-htpc-brightness-min.sh",
                        shortcut="Home Page",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Picture Toggle",
                        exec="lounge-htpc-picture-toggle.sh",
                        shortcut="Menu",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Power Toggle",
                        exec="lounge-htpc-power-toggle.sh",
                        shortcut="Menu",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Volume Down",
                        exec="lounge-htpc-volume-down.sh",
                        shortcut="Volume Down",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Volume Mute Toggle",
                        exec="lounge-htpc-volume-mute-toggle.sh",
                        shortcut="Volume Mute",
                    ),
                    GlobalShortcut(
                        name="Lounge HTPC Volume Up",
                        exec="lounge-htpc-volume-up.sh",
                        shortcut="Volume Up",
                    ),
                ]
            )
        case "mars" | "phobos":
            global_shortcuts.extend(
                [
                    GlobalShortcut(
                        name="Center and scale the focused window",
                        exec=str(DOTFILES / "kde" / "kde-center-scaled"),
                        shortcut="Meta+Shift+C",
                    ),
                    GlobalShortcut(
                        name="Toggle tmux-scratchpad",
                        exec=str(
                            DOTFILES / "kde" / "kde-toggle-tmux-scratchpad"
                        ),
                        shortcut="Meta+Return",
                    ),
                ]
            )

    desktop_id_counts = {}
    for shortcut in global_shortcuts:
        desktop_id = shortcut.desktop_id
        desktop_id_counts[desktop_id] = (
            desktop_id_counts.get(desktop_id, 0) + 1
        )

    desktop_id_usage = {}
    unique_desktop_ids = []
    for shortcut in global_shortcuts:
        base_id = shortcut.desktop_id
        if desktop_id_counts[base_id] > 1:
            counter = desktop_id_usage.get(base_id, 0) + 1
            desktop_id_usage[base_id] = counter
            unique_id = f"{base_id}-{counter}"
        else:
            unique_id = base_id
        unique_desktop_ids.append(unique_id)

    for file, file_groups in settings.items():
        for group, keys in file_groups.items():
            for key, value in keys.items():
                await kwriteconfig6(
                    file=file,
                    groups=group,
                    key=key,
                    value=value,
                    notify=True,
                )

    for file, file_groups in settings_nested_groups.items():
        for group, keys in file_groups.items():
            if isinstance(group, tuple):
                groups = list(group)
            else:
                groups = group
            for key, value in keys.items():
                await kwriteconfig6(
                    file=file,
                    groups=groups,
                    key=key,
                    value=value,
                    notify=True,
                )

    for shortcut, unique_id in zip(global_shortcuts, unique_desktop_ids):
        write_desktop_file(
            name=shortcut.name,
            exec=shortcut.exec,
            desktop_id=unique_id,
        )

    for shortcut, unique_id in zip(global_shortcuts, unique_desktop_ids):
        groups = ["services", f"net.local.dotfiles.{unique_id}.desktop"]
        await kwriteconfig6(
            file="kglobalshortcutsrc",
            groups=groups,
            key="_launch",
            value=shortcut.shortcut,
            notify=True,
        )

    # Track kwin PID to detect when restart needed
    runtime_dir = pathlib.Path(
        os.environ.get("XDG_RUNTIME_DIR", f"/run/user/{os.getuid()}")
    )
    pid_file = runtime_dir / "kde-shortcuts-kwin-pid"

    # Get current kwin_wayland PID
    try:
        proc = await asyncio.create_subprocess_exec(
            "pgrep",
            "-x",
            "kwin_wayland",
            stdout=asyncio.subprocess.PIPE,
        )
        stdout, _ = await proc.communicate()
        current_pid = stdout.decode().strip()
    except Exception:
        current_pid = ""

    # Check if PID changed (indicates restart happened)
    try:
        stored_pid = pid_file.read_text().strip()
    except FileNotFoundError:
        stored_pid = ""

    if current_pid and current_pid != stored_pid:
        # PID changed or first run - update and warn
        pid_file.write_text(current_pid)
        if not stored_pid:
            # First run - need restart
            print("WARNING: Logout required to load updated shortcuts.")
    elif stored_pid and current_pid == stored_pid:
        # PID unchanged - shortcuts still need activation
        print("WARNING: Logout required to load updated shortcuts.")

    expected_files = {
        LOCAL_SHARE
        / "applications"
        / f"net.local.dotfiles.{unique_id}.desktop"
        for unique_id in unique_desktop_ids
    }
    applications_dir = LOCAL_SHARE / "applications"
    if applications_dir.exists():
        for desktop_file in applications_dir.glob(
            "net.local.dotfiles.*.desktop"
        ):
            if desktop_file not in expected_files:
                desktop_file.unlink()


async def main():
    if not shutil.which("plasmashell"):
        exit()

    for target, source in LINKS.items():
        symlink(target, source)

    if HOSTNAME:
        source = DOTFILES / "kde" / "applications_host" / HOSTNAME
        target = LOCAL_SHARE / "applications" / "dotfiles-localhost"
        if source.exists():
            await Rsync.copy_into_replace_contents(source, target)
        else:
            delete(target)

    if HOSTNAME in ("mars", "phobos"):
        await update_desktop_database()

    await configure_kde()


if __name__ == "__main__":
    asyncio.run(main())
