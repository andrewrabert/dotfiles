#!/usr/bin/env python3
import asyncio
import pathlib
import shutil


async def main():
    if not shutil.which("krita"):
        return

    # Get krita package files
    proc = await asyncio.create_subprocess_exec(
        "pacman",
        "-Ql",
        "krita",
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    stdout, _ = await proc.communicate()

    if proc.returncode != 0:
        raise Exception(f"pacman -Ql krita failed: {proc.returncode}")

    # Filter for .desktop files in /usr/share/applications/
    desktop_files = [
        line.split()[1]
        for line in stdout.decode().splitlines()
        if "/usr/share/applications/" in line and line.endswith(".desktop")
    ]

    # Check which files need modification
    files_to_modify = []
    for desktop_path in desktop_files:
        src = pathlib.Path(desktop_path)
        if not src.exists():
            continue

        content = src.read_text()
        if "\nNoDisplay=true" in content or content.startswith(
            "NoDisplay=true"
        ):
            files_to_modify.append(src)

    if not files_to_modify:
        return

    # Modify all files in single sed call
    file_paths = [str(f) for f in files_to_modify]
    proc = await asyncio.create_subprocess_exec(
        "sudo",
        "sed",
        "-i",
        "s/^NoDisplay=true/NoDisplay=false/",
        *file_paths,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    await proc.communicate()

    if proc.returncode != 0:
        raise Exception(f"sed failed: {proc.returncode}")

    print(f"modified {len(files_to_modify)} files")


if __name__ == "__main__":
    asyncio.run(main())
