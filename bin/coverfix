#!/bin/bash 

# ensure album art meets the ridiculous limit the PowerAmp devs decided to hard code 

IFS=$'\n'

usage ()
{
	cat << EOF
Usage:  coverfix [options]

OPTIONS:
	-h		Help
	-m 		MTP
	-s		SSHFS
EOF
}

fix_music ()
{
	cd "$MUSIC_PATH"
	echo "Converting .png to .jpg"
	find ./ -name "*.png" -exec mogrify -format jpg  {} \; 
	echo "Deleting .png"
	find ./ -name "*.png" -exec rm  {} \; 
	echo "Shrinking .jpg"
	# previous tried to convert to 1MB instead of 1.5MB. However, the process would hang on occasion.
	# I assume that mogrify has trouble bringing the image down to 1MB.
	#
	# Got a nexus 5 and changed the size from 1000 to 2000
	find ./ -size +1500k -name "*.jpg" -exec mogrify -define jpeg:extent=1500kb -resize 1000 {} \; 
	
	# fix permissions
	# - not sure why I need this, but problems came up
	echo "chmod music directory"
	chmod -R 777 "$MUSIC_PATH"
}


MUSIC_PATH=
while getopts ":hms" OPTION
do
	case $OPTION in
		s)
			MUSIC_PATH=/mnt/nexus5/storage/emulated/0/Music
			;;
		m)
		#	MUSIC_PATH=/mnt/nexus5/Internal\ storage/Music
			MUSIC_PATH=/home/draje/nexus/Internal\ storage/Music
			;;
		?)
			usage
			exit
			;;
		h)
			usage
			exit
			;;
	esac
done

if [ -z $MUSIC_PATH ]
then
	usage
else
	fix_music
fi
